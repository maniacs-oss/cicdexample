#!/bin/bash

# Timestamp Function
timestamp() {
	date +"%T"
}

# Temporary file for stderr redirects
tmpfile=$(mktemp)

# Go build
build () {
	echo "â²ï¸	$(timestamp): started build script..."
	echo "ğŸ—ï¸	$(timestamp): building cicdexample"
	go build 2>tmpfile
	if [ -s tmpfile ]; then
		cat tmpfile
		echo "âŒ	$(timestamp): compilation error, exiting"
		exit 1
	fi
}

# Build a docker image
buildDocker() {
	echo "ğŸ‹	$(timestamp): building image example:test"
	docker build -t example:test .
}

# Deploy to Minikube using kubectl
deploy() {
	echo "ğŸŒ§ï¸	 $(timestamp): deploying to Minikube"
	kubectl delete deployment example
	kubectl delete service example
	kubectl apply -f deploy.yml
}

# Orchestrate
echo "ğŸ¤–	Welcome to the Builder builder v0.2, written by github.com/cishiv"
if [[ $1 = "build" ]]; then
	if [[ $2 = "docker" ]]; then
		if [[ $3 = "deploy" ]]; then
			build
			buildDocker
			deploy
		else
			build
			buildDocker
		fi
		echo "âœ”ï¸	$(timestamp): complete."
		echo "ğŸ‘‹	$(timestamp): exiting..."
	elif [[ $2 = "bin" ]]; then
		build
		echo "âœ”ï¸	$(timestamp): complete."
		echo "ğŸ‘‹	$(timestamp): exiting..."
	else
		echo "ğŸ¤”   $(timestamp): missing build argument"
	fi
else
	if [[ $1 = "--help" ]]; then
		echo "build - start a build to produce artifacts"
		echo "	docker - produces docker images"
		echo " 	bin - produces executable binaries"
	else
		echo "ğŸ¤”	$(timestamp): no arguments passed, type --help for a list of arguments"
	fi
fi
rm -f tmpfile
